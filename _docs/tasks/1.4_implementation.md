# Phase 1.4 Implementation: Real-time Messaging & Snaps

**Goal**: Develop the direct messaging feature for sending and receiving disappearing text and media-based Snaps.

**Tech Stack**: `Firestore`, `Firebase Storage`, `Riverpod`, `Isar`.

---

## Current Status

### âœ… Already Complete
- Firebase Infrastructure (Core, Auth, Firestore, Storage)
- User Authentication with `UserModel` and profiles
- Navigation with Messages tab at `/messages`
- Placeholder Messages screen with Material 3 design
- Project architecture with feature-based structure
- Riverpod state management setup

### ðŸš§ Missing Components
- Isar dependency for local caching
- Data models (Conversation, Message, Snap)
- Data layer repositories and providers
- Real chat screen implementation
- Firestore schema and real-time functionality
- Snap upload and disappearing logic

---

## Implementation Plan

### Step 1: Setup Dependencies and Models
**Goal**: Add Isar dependency and create core data models

1. **Add Isar to pubspec.yaml**
   - `isar: ^3.1.0+1`
   - `isar_flutter_libs: ^3.1.0+1`
   - Update dev_dependencies for code generation

2. **Create Data Models**
   - `ConversationModel` - Chat conversations with participants
   - `MessageModel` - Individual messages (text/snap)
   - `SnapModel` - Media references with metadata

3. **Generate Isar Schema**
   - Run code generation for Isar
   - Verify schema compilation

### Step 2: Data Layer Implementation
**Goal**: Implement repositories and state management

1. **MessagesRepository**
   - Firestore CRUD operations for conversations
   - Real-time streams for message updates
   - Snap upload to Firebase Storage
   - Disappearing message deletion logic

2. **IsarCacheRepository**
   - Local conversation caching
   - Message history storage
   - Offline data synchronization

3. **Riverpod Providers**
   - Conversation list provider
   - Individual conversation provider
   - Message sending actions

### Step 3: UI Enhancement
**Goal**: Transform placeholder UI to functional messaging interface

1. **Enhance MessagesScreen**
   - Replace mock data with real Firestore streams
   - Implement search functionality
   - Add new conversation creation

2. **Build ChatScreen**
   - Message list with real-time updates
   - Text input with send functionality
   - Snap attachment integration
   - Typing indicators

3. **Create Message Widgets**
   - Text message bubbles
   - Snap message previews
   - Message status indicators (sent/delivered/read)

### Step 4: Real-time Features
**Goal**: Implement core messaging functionality

1. **Firestore Streams**
   - Live conversation updates
   - Real-time message delivery
   - Participant status tracking

2. **Message Sending**
   - Text message creation
   - Snap upload and reference creation
   - Message delivery confirmation

3. **Camera Integration**
   - Connect with existing camera feature
   - Direct Snap sharing to conversations
   - Media processing and optimization

### Step 5: Advanced Features
**Goal**: Add sophisticated messaging features

1. **Disappearing Logic**
   - Message expiration after viewing
   - Automatic cleanup from Firestore
   - Storage file deletion

2. **Read Status & Indicators**
   - Message read tracking
   - Typing indicators
   - Online/offline status

3. **Performance Optimization**
   - Message pagination
   - Cache management
   - Memory optimization

---

## Firestore Schema Design

### Collections Structure

```
/conversations/{conversationId}
â”œâ”€â”€ id: string
â”œâ”€â”€ participants: string[] (user IDs)
â”œâ”€â”€ participantData: {userId: {username, lastSeen}}
â”œâ”€â”€ lastMessage: MessageModel
â”œâ”€â”€ lastMessageTime: timestamp
â”œâ”€â”€ createdAt: timestamp
â”œâ”€â”€ updatedAt: timestamp
â”œâ”€â”€ type: 'direct' | 'group'
â”œâ”€â”€ groupName?: string (for group chats)

/conversations/{conversationId}/messages/{messageId}
â”œâ”€â”€ id: string
â”œâ”€â”€ senderId: string
â”œâ”€â”€ senderUsername: string
â”œâ”€â”€ content?: string (for text messages)
â”œâ”€â”€ snapRef?: string (Firebase Storage path)
â”œâ”€â”€ snapDuration?: number (1-10 seconds)
â”œâ”€â”€ timestamp: timestamp
â”œâ”€â”€ viewedBy: {userId: timestamp}
â”œâ”€â”€ expiresAt?: timestamp (for disappearing)
â”œâ”€â”€ messageType: 'text' | 'snap'
```

### Firebase Storage Structure

```
/snaps/{conversationId}/{messageId}/{filename}
```

---

## Isar Schema Design

### Local Cache Collections

```dart
@collection
class CachedConversation {
  Id id = Isar.autoIncrement;
  String conversationId;
  List<String> participants;
  String? lastMessageText;
  DateTime lastMessageTime;
  String conversationType;
  bool hasUnread;
  int unreadCount;
}

@collection
class CachedMessage {
  Id id = Isar.autoIncrement;
  String messageId;
  String conversationId;
  String senderId;
  String? content;
  String? snapRef;
  DateTime timestamp;
  String messageType;
  bool isRead;
}
```

---

## Key Implementation Notes

### Security Considerations
- Firestore security rules for conversation access
- User authentication verification
- Privacy controls for message viewing

### Performance Optimizations
- Paginated message loading (20-50 messages per batch)
- Efficient Isar indexing on frequently queried fields
- Proper stream disposal and memory management

### Error Handling
- Network failure graceful degradation
- Upload retry logic for failed Snaps
- Cache fallback when Firestore unavailable

### Testing Strategy
- Unit tests for repositories and models
- Integration tests for real-time functionality
- UI tests for message flow

---

## Success Criteria

### Phase 1.4 Complete When:
1. âœ… Users can view real conversations list
2. âœ… Real-time messaging works (send/receive text)
3. âœ… Snap sending and viewing functionality
4. âœ… Disappearing messages after viewing
5. âœ… Basic offline caching with Isar
6. âœ… Integration with existing camera feature
7. âœ… Group messaging support
8. âœ… Read status and indicators

### Performance Targets
- Message send latency < 1 second
- Real-time updates < 500ms
- Offline cache load < 200ms
- Memory usage stable during long conversations

---

## Next Steps After 1.4
- Enhanced group management (Phase 1.7)
- Advanced AR filters integration
- Message search and media gallery
- Push notifications for messages
- Message reactions and replies 